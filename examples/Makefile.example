# Example Makefile for building with DuckLake C++ API
# This requires a custom build of DuckDB with ducklake statically compiled

EXTENSION = custom_metadata_manager
MODULE_big = custom_metadata_manager
OBJS = custom_metadata_manager.o
DATA = custom_metadata_manager--1.0.sql

# Enable ducklake C++ API
override PG_CPPFLAGS += -DENABLE_DUCKLAKE_CPP_API

# Include paths
override PG_CPPFLAGS += -I$(CURDIR)/../third_party/pg_duckdb/include
override PG_CPPFLAGS += -I$(CURDIR)/../third_party/ducklake/src/include
override PG_CPPFLAGS += -isystem $(CURDIR)/../third_party/pg_duckdb/third_party/duckdb/src/include

# C++ standard
override PG_CXXFLAGS += -std=c++17

# Link against pg_duckdb (which contains DuckDB and ducklake)
SHLIB_LINK += -Wl,-rpath,$(PG_LIB)/ -L$(PG_LIB) -lstdc++

# On macOS, allow symbols to be resolved from pg_duckdb
ifeq ($(shell uname -s), Darwin)
	SHLIB_LINK += -Wl,-undefined,dynamic_lookup
endif

include ../Makefile.global

# Note: This will fail to compile without:
# 1. DuckDB built with ducklake as static extension
# 2. pg_duckdb built against that DuckDB
# 3. All headers properly installed

.PHONY: check-deps
check-deps:
	@echo "Checking dependencies..."
	@if [ ! -f "$(CURDIR)/../third_party/ducklake/src/include/storage/ducklake_metadata_manager.hpp" ]; then \
		echo "ERROR: DuckLake headers not found"; \
		exit 1; \
	fi
	@echo "Dependencies OK"
